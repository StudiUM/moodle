{"version":3,"sources":["../src/calendar_mini.js"],"names":["define","$","CalendarSelectors","CalendarEvents","CalendarViewManager","registerCalendarEventListeners","root","body","namespace","attr","on","created","reloadMonth","deleted","updated","eventMoved","e","data","is","reloadCurrentMonth","off","registerEventListeners","filterChanged","daysWithEvent","find","eventType","type","toggleClass","hidden","elements","courseSelector","selectElement","courseId","val","groupSelector","firstOption","children","first","empty","append","text","reloadGroupSelector","done","length","hide","addClass","show","removeClass","each","index","value","id","name","substring","appendTo","groupId","then","fail","Notification","exception","init","loadOnInit"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is the highest level module for the calendar. It is\n * responsible for initialising all of the components required for\n * the calendar to run. It also coordinates the interaction between\n * components by listening for and responding to different events\n * triggered within the calendar UI.\n *\n * @module     core_calendar/calendar_mini\n * @copyright  2017 Andrew Nicols <andrew@nicols.co.uk>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core_calendar/selectors',\n    'core_calendar/events',\n    'core_calendar/view_manager',\n],\nfunction(\n    $,\n    CalendarSelectors,\n    CalendarEvents,\n    CalendarViewManager\n) {\n\n    /**\n     * Listen to and handle any calendar events fired by the calendar UI.\n     *\n     * @method registerCalendarEventListeners\n     * @param {object} root The calendar root element\n     */\n    var registerCalendarEventListeners = function(root) {\n        var body = $('body');\n        var namespace = '.' + root.attr('id');\n\n        body.on(CalendarEvents.created + namespace, root, reloadMonth);\n        body.on(CalendarEvents.deleted + namespace, root, reloadMonth);\n        body.on(CalendarEvents.updated + namespace, root, reloadMonth);\n        body.on(CalendarEvents.eventMoved + namespace, root, reloadMonth);\n    };\n\n    /**\n     * Reload the month view in this month.\n     *\n     * @param {EventFacade} e\n     */\n    var reloadMonth = function(e) {\n        var root = e.data;\n        var body = $('body');\n        var namespace = '.' + root.attr('id');\n\n        if (root.is(':visible')) {\n            CalendarViewManager.reloadCurrentMonth(root);\n        } else {\n            // The root has been removed.\n            // Remove all events in the namespace.\n            body.off(CalendarEvents.created + namespace);\n            body.off(CalendarEvents.deleted + namespace);\n            body.off(CalendarEvents.updated + namespace);\n            body.off(CalendarEvents.eventMoved + namespace);\n        }\n    };\n\n    var registerEventListeners = function(root) {\n        $('body').on(CalendarEvents.filterChanged, function(e, data) {\n            var daysWithEvent = root.find(CalendarSelectors.eventType[data.type]);\n\n            daysWithEvent.toggleClass('calendar_event_' + data.type, !data.hidden);\n        });\n\n        var namespace = '.' + root.attr('id');\n        $('body').on('change' + namespace, CalendarSelectors.elements.courseSelector, function() {\n            if (root.is(':visible')) {\n                var selectElement = $(this);\n                var courseId = selectElement.val();\n                var categoryId = null;\n                var courseSelector = root.find(CalendarSelectors.elements.courseSelector);\n\n                var groupSelector = root.find(CalendarSelectors.elements.groupSelector);\n                var firstOption = groupSelector.children().first();\n                groupSelector.empty();\n                groupSelector.append('<option value=\"' + firstOption.val() + '\">' + firstOption.text() + '</option>');\n\n                if (courseId > 1) {\n                    CalendarViewManager.reloadGroupSelector(courseId)\n                        .done(function(data) {\n                            if (data.length === 0) {\n                                groupSelector.hide();\n                                courseSelector.addClass('mr-auto');\n                            } else {\n                                groupSelector.show();\n                                courseSelector.removeClass('mr-auto');\n\n                                $.each(data, function(index, value) {\n                                    $(\"<option/>\", {\n                                        value: value.id,\n                                        text: value.name.length > 15 ? value.name.substring(0, 14) + '...' : value.name\n                                    }).appendTo(groupSelector);\n                                });\n                            }\n                        });\n                } else {\n                    groupSelector.hide();\n                    courseSelector.addClass('mr-auto');\n                }\n\n                CalendarViewManager.reloadCurrentMonth(root, courseId, categoryId);\n            } else {\n                $('body').off('change' + namespace);\n            }\n        });\n\n        root.on('change', CalendarSelectors.elements.groupSelector, function() {\n            var selectElement = $(this);\n            var groupId = selectElement.val();\n            var courseId = root.find(CalendarSelectors.elements.courseSelector).val();\n            CalendarViewManager.reloadCurrentMonth(root, courseId, null)\n                .then(function() {\n                    // We need to get the group selector again because the content has changed.\n                    return root.find(CalendarSelectors.elements.groupSelector).val(groupId);\n                })\n                .fail(Notification.exception);\n        });\n    };\n\n    return {\n        init: function(root, loadOnInit) {\n            root = $(root);\n\n            CalendarViewManager.init(root);\n            registerEventListeners(root);\n            registerCalendarEventListeners(root);\n\n            if (loadOnInit) {\n                // The calendar hasn't yet loaded it's events so we\n                // should load them as soon as we've initialised.\n                CalendarViewManager.reloadCurrentMonth(root);\n            }\n        }\n    };\n});\n"],"file":"calendar_mini.min.js"}